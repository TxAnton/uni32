# Практическое задание 8
Ларин Антон  
Гр. 8383
  
## Условие задачи

> Вариант 6   

Необходимо реализовать собственной CallBack, и провести обучение вашей модели из практического занятия №6 с написанным CallBack’ом. То, какой CallBack необходимо реализовать определяется вариантом.

#### Вариант 6
Построение и сохранение таблицы со следующими данными: номер эпохи, номер наблюдения с наименьшей точностью классификации на заданной эпохе, к какому классу принадлежит наблюдение, точность классификации, значение ошибки.  
Каждая строчка должна рассчитываться с заданным пользователем интервалом начиная с 0 эпохи, а также на самой последней



## Выполнение работы

CustomCallback был отнаследован от keras.callbacks.Callback
При создании ему передаются данные для обучения, а также значение интервала. через которое он будет выполнять обработку

В классе коллбэка переопределены два метода on_epoch_end и on_train_end
  
Первый вызывается при в конце каждой эпохи. В нем проверяется прошел ли интервал и сама обработка данных - формируется одна строка таблыцы, содержащая информацию о наблюдении с наименьшей точностью  
```python
def on_epoch_end(self, epoch, logs=None):
        n_epochs = self.params["epochs"]
        if epoch % self.interval == 0 or epoch == n_epochs - 1:
            pred = self.model.predict(self.data)
            acc = 1 - abs(self.labels - pred)
            acc= np.mean(acc,axis=1)
            f_loss = keras.losses.get(self.model.loss)
            losses = np.asarray(f_loss(self.labels, pred))
            min_ix = np.argmin(acc)
            min_acc = acc.flatten()[min_ix]
            min_loss = losses[min_ix]
            min_class = self.labels.flatten()[min_ix]
            self.d["epoch"].append(epoch)
            self.d["ix"].append(min_ix)
            self.d["class"].append(int(min_class))
            self.d["acc"].append(min_acc)
            self.d["err"].append(min_loss)
```
Т.к. задачи была решена в стиле многоклассовой классификации значение точности считается как среднее между оценками каждой компоненты вектора классов


Второй метод вызывается в конце всего обучения. Он берет значения из таблицы и созраняет их в виде csv

```python
table = pandas.DataFrame(data=self.d)
        table.to_csv("table.csv")
```

## Полученные результаты


| epoch | ix  | class | acc                 | err                 |
| ----- | --- | ----- | ------------------- | ------------------- |
| 0     | 42  | 1     | 0.216432124376297   | 1.5304784774780273  |
| 4     | 393 | 1     | 0.07684558629989624 | 2.5659573078155518  |
| 8     | 386 | 1     | 0.403898686170578   | 0.9065911769866943  |
| 12    | 394 | 1     | 0.4609999656677246  | 0.7743573188781738  |
| 16    | 386 | 1     | 0.6810131072998047  | 0.384173721075058   |
| 19    | 386 | 1     | 0.8506392240524292  | 0.16176724433898926 |

